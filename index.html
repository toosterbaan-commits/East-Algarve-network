<script>
    // ========= 1. FIREBASE CONFIGURATIE EN INITIALISATIE =========
    const firebaseConfig = {
      // LET OP: Gebruik hier jouw ECHTE Firebase configuratie!
      apiKey: "AIzaSyD8X8zLlVEbCJsk_T7IgwGvjpMk39GjxVU", 
      authDomain: "oost-algarve-network.firebaseapp.com",
      projectId: "oost-algarve-network",
      storageBucket: "oost-algarve-network.firebasestorage.app",
      messagingSenderId: "905979737722",
      appId: "1:905979737722:web:a7df5a062f7f058c3b2dc3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();     
    const db = firebase.firestore(); 
    let currentUserId = null; // Opslag voor de unieke ID van de ingelogde gebruiker
    let currentUserNaam = "Onbekende Verhuurder"; // Nieuwe variabele om de naam op te slaan

    // === 2. AUTHENTICATIE LOGICA ===

    function registreerGebruiker(event) {
        event.preventDefault(); 
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-wachtwoord').value;
        const naam = document.getElementById('reg-naam').value;

        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                // Sla het basisprofiel op in Firestore
                return db.collection("gebruikers").doc(user.uid).set({
                    Naam: naam,
                    Email: email,
                    Rol: "Verhuurder",
                    Status_Verificatie: "Niet Geverifieerd",
                    Locatie_Focus: "Nog In Te Vullen",
                    Telefoon_Publiek: false,
                    Bio: ""
                });
            })
            .then(() => {
                console.log("Registratie succesvol!");
            })
            .catch((error) => {
                console.error("Fout bij registratie:", error.message);
                toonMelding('Auth', "Fout bij registratie: " + error.message, 'red');
            });
    }

    function logInGebruiker(event) {
        event.preventDefault(); 
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-wachtwoord').value;

        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                console.log("Succesvol ingelogd!");
            })
            .catch((error) => {
                console.error("Fout bij inloggen:", error.message);
                toonMelding('Auth', "Fout bij inloggen: Controleer e-mail en wachtwoord.", 'red');
            });
    }
    
    function logUit() {
        auth.signOut().then(() => {
            console.log("Uitgelogd!");
            verbergAlles();
            document.getElementById('Auth').style.display = 'block';
            window.location.reload(); 
        }).catch((error) => {
            console.error("Fout bij uitloggen:", error);
        });
    }


    // === 3. NAVIGATIE EN UI LOGICA ===

    // Toon een tijdelijke melding in een specifieke module
    function toonMelding(moduleId, bericht, type = 'green') {
        const meldingDiv = document.getElementById('profiel-melding'); // Hergebruik profiel melding div voor nu
        // Omdat de gebruiker alert() voorstelde, blijven we dicht bij hun wens, 
        // maar in een echte app zou een mooie, getargete melding beter zijn.
        alert(bericht); 
    }

    function verbergAlles() {
        document.querySelectorAll('.module').forEach(sec => {
            sec.style.display = 'none';
        });
        document.getElementById('app-container').style.display = 'none';
        document.getElementById('nav-bar').style.display = 'none';
        document.getElementById('Welkomst').style.display = 'none'; 
        document.getElementById('Auth').style.display = 'none';
    }

    function startApp(uid, naam) {
        currentUserId = uid; 
        currentUserNaam = naam; // Stel de naam in
        verbergAlles();
        document.getElementById('app-container').style.display = 'block';
        document.getElementById('nav-bar').style.display = 'flex';
        wisselModule('Verwijzingen'); // Start nu op het prikbord
    }
    
    function toonLogin() {
        document.getElementById('registratie-formulier').style.display = 'none';
        document.getElementById('login-formulier').style.display = 'block';
    }
    function toonRegistratie() {
        document.getElementById('registratie-formulier').style.display = 'block';
        document.getElementById('login-formulier').style.display = 'none';
    }

    function wisselModule(moduleId) {
        document.querySelectorAll('#app-container .module').forEach(sec => {
            sec.style.display = 'none';
        });
        document.getElementById(moduleId).style.display = 'block';
        
        // Laad data voor de actieve module
        if (moduleId === 'Verwijzingen') prikbordLaden();
        if (moduleId === 'Netwerk') netwerkLaden();
        if (moduleId === 'Kennisbank') kennisbankLaden();
        if (moduleId === 'Profiel') profielLaden(); 
    }

    // === 4. PRIKBORD LOGICA ===
    
    // Functie om de HTML voor één prikborditem te genereren
    function renderPrikbordItem(doc) {
        const data = doc.data();
        const datum = data.Timestamp ? data.Timestamp.toDate().toLocaleDateString('nl-NL', { hour: '2-digit', minute: '2-digit' }) : 'Onbekende Datum';
        const isMijnPost = data.GebruikerId === currentUserId;
        const statusKleur = data.Status === 'Actief' ? 'text-green-600' : 'text-orange-500';

        return `
            <div class="verwijzing-kaart">
                <h3 class="font-bold text-lg text-blue-600">${data.Locatie} - Beschikbaar!</h3>
                <p class="text-sm text-gray-500">
                    Geplaatst door: **${data.GebruikersNaam}** | ${datum} | Status: <span class="${statusKleur} font-semibold">${data.Status}</span>
                </p>
                <p class="mt-2 text-gray-700">${data.Details.replace(/\n/g, '<br>')}</p>
                <div class="mt-3 flex gap-2">
                    <button class="bg-green-500 text-white p-2 rounded-lg text-sm hover:bg-green-600">Reageer (DM)</button>
                    ${isMijnPost ? `
                        <button class="bg-yellow-500 text-white p-2 rounded-lg text-sm hover:bg-yellow-600" onclick="wisselStatusPrikbordItem('${doc.id}', '${data.Status}')">
                            Status Wijzigen
                        </button>
                        <button class="bg-red-500 text-white p-2 rounded-lg text-sm hover:bg-red-600" onclick="verwijderPrikbordItem('${doc.id}')">
                            Verwijder
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }

    // Real-time laden en weergeven van prikbordberichten
    function prikbordLaden() {
        const lijst = document.getElementById('verwijzingen-lijst');
        lijst.innerHTML = '<p class="text-gray-500 p-4">Laden van verwijzingen...</p>';

        // Real-time listener op de 'prikbord' collectie
        db.collection("prikbord")
            .orderBy("Timestamp", "desc") // Sorteer op de meest recente eerst
            .onSnapshot(snapshot => {
                lijst.innerHTML = '';
                if (snapshot.empty) {
                    lijst.innerHTML = '<p class="text-gray-500 p-4">Er zijn momenteel geen verwijzingen beschikbaar.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    lijst.innerHTML += renderPrikbordItem(doc);
                });
            }, error => {
                console.error("Fout bij laden prikbord:", error);
                lijst.innerHTML = '<p class="text-red-500 p-4">Fout bij het laden van het prikbord.</p>';
            });
    }

    // Toon/verberg het formulier en zorg dat het de 'verstuur' logica bevat
    function toonFormulier() {
        const formulierDiv = document.getElementById('verwijzing-formulier');
        if (formulierDiv.style.display === 'none' || formulierDiv.style.display === '') {
            formulierDiv.innerHTML = `
                <div class="p-4 border border-gray-300 rounded-lg mt-4 bg-yellow-50">
                    <h3 class="font-bold mb-3">Verwijzing Aanbieden</h3>
                    <form onsubmit="verstuurPrikbordItem(event)">
                        <input type="text" id="prikbord-locatie" placeholder="Locatie van accommodatie (bijv. Fuseta T2)" class="w-full p-2 border rounded mb-2" required>
                        <textarea id="prikbord-details" rows="4" placeholder="Details over de accommodatie en de beschikbaarheid (bijv. Beschikbaar: 1-15 Augustus | Reden: Annulering | Min. verblijf 5 nachten)" class="w-full p-2 border rounded mb-2" required></textarea>
                        <button type="submit" class="knop-primair">Verstuur Aanbod</button>
                        <button type="button" class="knop-primair mt-2 bg-gray-500 hover:bg-gray-700" onclick="document.getElementById('verwijzing-formulier').style.display='none'">Annuleren</button>
                    </form>
                </div>
            `;
            formulierDiv.style.display = 'block';
        } else {
            formulierDiv.style.display = 'none';
        }
    }

    // Data opslaan in Firestore
    function verstuurPrikbordItem(event) {
        event.preventDefault();

        const locatie = document.getElementById('prikbord-locatie').value.trim();
        const details = document.getElementById('prikbord-details').value.trim();

        if (!locatie || !details) {
            toonMelding('Verwijzingen', 'Vul zowel de locatie als de details in.', 'red');
            return;
        }

        db.collection("prikbord").add({
            Locatie: locatie,
            Details: details,
            GebruikerId: currentUserId,
            GebruikersNaam: currentUserNaam, // Gebruik de cached naam
            Status: "Actief", // Kan 'Actief' of 'Afgehandeld' zijn
            Timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            toonMelding('Verwijzingen', 'Aanbod succesvol op het prikbord geplaatst!', 'green');
            document.getElementById('verwijzing-formulier').style.display = 'none'; // Verberg het formulier
            // prikbordLaden() wordt automatisch aangeroepen door de onSnapshot listener
        })
        .catch(error => {
            console.error("Fout bij opslaan prikborditem:", error);
            toonMelding('Verwijzingen', 'Fout bij het versturen: ' + error.message, 'red');
        });
    }

    // Functie om de status van een item te wijzigen (Actief <-> Afgehandeld)
    function wisselStatusPrikbordItem(docId, huidigeStatus) {
        const nieuweStatus = huidigeStatus === 'Actief' ? 'Afgehandeld' : 'Actief';
        
        if (confirm(`Weet u zeker dat u de status wilt wijzigen naar "${nieuweStatus}"?`)) {
             db.collection("prikbord").doc(docId).update({
                Status: nieuweStatus
            })
            .then(() => {
                toonMelding('Verwijzingen', `Status succesvol gewijzigd naar ${nieuweStatus}.`, 'green');
            })
            .catch(error => {
                console.error("Fout bij status wijzigen:", error);
                toonMelding('Verwijzingen', 'Fout bij status wijzigen: ' + error.message, 'red');
            });
        }
    }

    // Functie om een item te verwijderen
    function verwijderPrikbordItem(docId) {
        if (confirm("Weet u zeker dat u dit prikborditem wilt verwijderen? Dit kan niet ongedaan gemaakt worden.")) {
            db.collection("prikbord").doc(docId).delete()
                .then(() => {
                    toonMelding('Verwijzingen', 'Item succesvol verwijderd.', 'green');
                })
                .catch(error => {
                    console.error("Fout bij verwijderen item:", error);
                    toonMelding('Verwijzingen', 'Fout bij verwijderen: ' + error.message, 'red');
                });
        }
    }

    // === 5. OVERIGE DATA LAADFUNCTIES (Onveranderd) ===

    function netwerkLaden() {
        const lijst = document.getElementById('netwerk-lijst');
        lijst.innerHTML = `
            <div class="netwerk-kaart">
                <h3 class="font-bold text-lg text-blue-800">Tavira Vakantiehuizen <span class="text-green-500 ml-2 text-sm">✔ Geverifieerd</span></h3>
                <p class="text-sm text-gray-600">Locatie Focus: Tavira & Santa Luzia</p>
                <p class="mt-2 text-gray-700">Specialiteit: Luxe villa's met zwembad. Zoek betrouwbare schoonmaakdiensten. (Placeholder data)</p>
            </div>
        `;
    }

    function kennisbankLaden() {
          const lijst = document.getElementById('kennisbank-lijst');
          lijst.innerHTML = `
            <div class="kennisbank-item border-l-4 border-yellow-500">
                <h3 class="font-bold text-lg">Document: Nieuwe Alojamento Local Regels 2024</h3>
                <p class="text-sm text-gray-600">Datum: 12-11-2024</p>
                <button class="bg-gray-300 text-gray-800 p-2 rounded-lg mt-2 text-sm">Download PDF</button>
            </div>
          `;
    }
    
    // === 6. PROFIEL BEWERKINGS LOGICA (Onveranderd) ===
    
    let profielData = {}; // Cache om profiel data tijdelijk op te slaan

    function profielLaden() {
        const detailsDiv = document.getElementById('profiel-details');
        detailsDiv.innerHTML = '<p class="text-gray-500 p-4">Laadt profielgegevens...</p>';
        
        if (currentUserId) {
            // Gebruik onSnapshot voor real-time updates (beste praktijk)
            db.collection("gebruikers").doc(currentUserId).onSnapshot(doc => {
                if (doc.exists) {
                    profielData = doc.data();
                    // Update de globale gebruikersnaam hier
                    currentUserNaam = profiel
